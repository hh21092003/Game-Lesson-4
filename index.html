<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Restaurant Service Speaking Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070a16;
      --card:#0f1633;
      --text:#edf0ff;
      --muted:#b9c2e6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.55);

      --accent:#ffd166;
      --accent2:#7bdff2;
      --ok:#2ee59d;
      --bad:#ff5d6c;

      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 12% 0%, rgba(123,223,242,.22), transparent 55%),
        radial-gradient(1000px 700px at 92% 28%, rgba(255,209,102,.16), transparent 60%),
        radial-gradient(900px 500px at 60% 105%, rgba(46,229,157,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(1040px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:18px 18px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), transparent);
      border-bottom:1px solid var(--line);
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,209,102,.95), rgba(123,223,242,.65));
      display:grid;place-items:center;
      font-weight:900;
      color:#070a16;
      letter-spacing:.5px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }

    .brand h1{
      margin:0;
      font-size:18px;
      line-height:1.2;
    }
    .brand p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .rightTools{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .btnSmall{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color: rgba(237,240,255,.92);
      font-size:12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease;
    }
    .btnSmall:hover{ transform: translateY(-1px); }

    .progressWrap{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .bar{
      flex:1;
      height:9px;
      background: rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--ok), var(--accent));
      transition: width .35s ease;
    }
    .lvlTxt{
      font-size:12px;color:var(--muted);
      min-width:140px;text-align:right;
    }

    .topRow2{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .playerCard{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      min-width:280px;
    }
    .playerBadge{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.16);
      font-size:18px;
    }
    .playerMeta{
      line-height:1.2;
      flex:1;
    }
    .playerMeta b{ display:block; font-size:13px; }
    .playerMeta span{ display:block; font-size:12px; color:var(--muted); margin-top:4px; }

    .scoreMini{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .scorePill{
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-size:12px;
      color: rgba(237,240,255,.92);
      min-width:140px;
      text-align:center;
    }
    .scorePill b{ font-size:14px; display:block; margin-top:2px; }

    .content{ padding:18px; }

    .gridMain{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .gridMain{ grid-template-columns: 1fr; }
    }

    .scenario{
      background:
        linear-gradient(180deg, rgba(255,209,102,.13), rgba(255,209,102,.05));
      border:1px solid rgba(255,209,102,.22);
      border-radius:16px;
      padding:14px 14px 12px;
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .scenario:before{
      content:"";
      position:absolute;
      inset:-60px -100px auto auto;
      width:220px;height:220px;
      background: radial-gradient(circle, rgba(123,223,242,.18), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .scenarioTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }

    .scenario h2{
      margin:0;
      font-size:16px;
      line-height:1.2;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .levelIcon{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.16);
      font-size:18px;
      flex:0 0 auto;
    }
    .scenario .desc{
      margin:8px 0 0;
      color: rgba(237,240,255,.93);
      font-size:13px;
      line-height:1.45;
    }
    .tag{
      font-size:12px;
      color: rgba(237,240,255,.88);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }

    .qBlock{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }

    .qTitle{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-bottom:10px;
    }
    .qTitle .icon{
      width:36px;height:36px;border-radius:13px;
      background: rgba(123,223,242,.16);
      border:1px solid rgba(123,223,242,.24);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .qTitle .text{
      flex:1;
      line-height:1.35;
    }
    .qTitle .text b{
      display:block;
      font-size:14px;
      margin-top:1px;
    }
    .qTitle .text .vi{
      margin-top:4px;
      font-size:12px;
      color: rgba(185,194,230,.95);
    }
    .qTitle .text .hint{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    .options{ display:grid; gap:10px; }

    .opt{
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.035));
    }
    .opt .badge{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      display:grid;place-items:center;
      font-weight:900;
      color: rgba(237,240,255,.95);
      flex:0 0 auto;
    }
    .opt .txt{
      font-size:13px;
      color: rgba(237,240,255,.96);
      line-height:1.35;
      flex:1;
    }

    .controls{
      display:grid;
      gap:12px;
      padding:14px;
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: 0 0 var(--radius) var(--radius);
    }

    .micRow{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }

    .micBtn{
      flex: 1 1 260px;
      border:none;
      border-radius:16px;
      padding:14px 14px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(255,93,108,.95), rgba(255,93,108,.62));
      color:white;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 34px rgba(255,93,108,.16);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, filter .12s ease;
    }
    .micBtn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .micBtn.listening{
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.62));
      box-shadow: 0 14px 34px rgba(46,229,157,.16);
    }
    .micBtn:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    .hintMini{
      flex: 1 1 300px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px 12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .typeRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .typeRow input{
      flex:1;
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px 12px;
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    .typeRow button{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(123,223,242,.95), rgba(123,223,242,.62));
      color:#070a16;
      font-weight:900;
      cursor:pointer;
      min-width:110px;
      transition: transform .12s ease;
    }
    .typeRow button:hover{ transform: translateY(-1px); }
    .typeRow button:disabled{opacity:.55; cursor:not-allowed; transform:none;}

    .live{
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:12px 12px;
    }
    .live .label{
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .k{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(237,240,255,.88);
      font-size:11px;
    }
    .live .transcript{
      font-size:14px;
      line-height:1.35;
      min-height:42px;
      color: rgba(237,240,255,.95);
      white-space:pre-wrap;
    }

    .status{
      border-radius:16px;
      padding:12px 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      font-size:13px;
      line-height:1.35;
    }
    .status.ok{
      border-color: rgba(46,229,157,.35);
      background: rgba(46,229,157,.12);
    }
    .status.bad{
      border-color: rgba(255,93,108,.35);
      background: rgba(255,93,108,.12);
    }

    .nextRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .nextBtn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,209,102,.95), rgba(255,209,102,.62));
      color:#070a16;
      font-weight:900;
      cursor:pointer;
      min-width:170px;
      display:none;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease;
    }
    .nextBtn.show{ display:inline-flex; }
    .nextBtn:hover{ transform: translateY(-1px); }

    .ghostBtn{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      cursor:pointer;
      min-width:160px;
    }

    /* Leaderboard */
    .board{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      position:sticky;
      top:14px;
    }
    .boardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .boardTop b{ font-size:13px; }
    .boardTop .mini{ font-size:12px; color:var(--muted); }
    .boardList{
      display:grid;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .rank{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      font-weight:900;
      color:#070a16;
      background: linear-gradient(180deg, rgba(255,209,102,.95), rgba(123,223,242,.70));
    }
    .rowMain{ flex:1; line-height:1.2; }
    .rowMain b{ display:block; font-size:12px; }
    .rowMain span{ display:block; margin-top:4px; font-size:11px; color:var(--muted); }
    .rowScore{
      text-align:right;
      min-width:84px;
    }
    .rowScore b{ display:block; font-size:14px; }
    .rowScore span{ display:block; margin-top:4px; font-size:11px; color:var(--muted); }

    .row.you{
      border-color: rgba(46,229,157,.25);
      background: rgba(46,229,157,.08);
    }

    /* Modal name */
    .modalWrap{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modal h3{
      margin:0;
      font-size:16px;
    }
    .modal p{
      margin:8px 0 14px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .modal .row2{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .modal input{
      flex:1;
      min-width:220px;
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px 12px;
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    .modal .startBtn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.62));
      color:#070a16;
      font-weight:900;
      cursor:pointer;
      min-width:140px;
      transition: transform .12s ease;
    }
    .modal .startBtn:hover{ transform: translateY(-1px); }

    .modal .smallBtns{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal .dangerBtn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,93,108,.14);
      border:1px solid rgba(255,93,108,.25);
      color: rgba(237,240,255,.92);
      font-weight:900;
      cursor:pointer;
    }
    .modal .ghostBtn2{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight:900;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="app">
    <section class="panel">
      <div class="header">
        <div class="titleRow">
          <div class="brand">
            <div class="logo">RS</div>
            <div>
              <h1>Restaurant Service Speaking Game</h1>
              <p>English for Tourism - speak one of the 3 options to pass</p>
            </div>
          </div>

          <div class="rightTools">
            <div class="pill" id="techPill">üéôÔ∏è Speech: checking‚Ä¶</div>
            <button class="btnSmall" id="changePlayerBtn" title="Change player">üë§ Change player</button>
            <button class="btnSmall" id="resetBoardBtn" title="Reset leaderboard">üßπ Reset board</button>
          </div>
        </div>

        <div class="progressWrap">
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="lvlTxt" id="lvlTxt">Level 1 of 7</div>
        </div>

        <div class="topRow2">
          <div class="playerCard">
            <div class="playerBadge">üéß</div>
            <div class="playerMeta">
              <b id="playerName">Player: -</b>
              <span id="playerHint">Enter your name to start. Your score is saved on this device.</span>
            </div>
          </div>

          <div class="scoreMini">
            <div class="scorePill">Total<b id="myTotal">0</b></div>
            <div class="scorePill">Avg accuracy<b id="myAvg">0.00</b></div>
            <div class="scorePill">Attempts<b id="myAtt">0</b></div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="gridMain">
          <div>
            <div class="scenario">
              <div class="scenarioTop">
                <div>
                  <h2><span class="levelIcon" id="lvlIcon">üçΩÔ∏è</span><span id="lvlTitle">Level 1 - Welcoming</span></h2>
                  <div class="desc" id="lvlDesc">A guest walks in. You cannot find their name on the reservation list.</div>
                </div>
                <div class="tag" id="lvlTag">üßæ Reservations</div>
              </div>
            </div>

            <div class="qBlock">
              <div class="qTitle">
                <div class="icon">üéØ</div>
                <div class="text">
                  <b id="qText">Choose the most professional line to say.</b>
                  <div class="vi" id="qTextVI">Ch·ªçn c√¢u chuy√™n nghi·ªáp nh·∫•t ƒë·ªÉ n√≥i.</div>
                  <div class="hint">Speak ONE of the 3 options. You can also type if needed.</div>
                </div>
              </div>
              <div class="options" id="options"></div>
            </div>

            <div class="controls">
              <div class="micRow">
                <button class="micBtn" id="micBtn" title="Tap to talk">
                  üéôÔ∏è Tap to Talk
                </button>
                <div class="hintMini">
                  <div class="k">Quick tips</div>
                  Read slowly, keep a short pause between words.<br/>
                  Best on <span class="k">Chrome</span> or <span class="k">Edge</span> with <span class="k">HTTPS</span>.
                </div>
              </div>

              <div class="typeRow">
                <input id="typeInput" type="text" placeholder='Type one option if mic fails‚Ä¶' />
                <button id="checkBtn">Check</button>
              </div>

              <div class="live">
                <div class="label">
                  <span>Transcript</span>
                  <span id="confTxt" class="k">conf: -</span>
                </div>
                <div class="transcript" id="transcript">Waiting‚Ä¶</div>
              </div>

              <div class="status" id="status">Ready. Tap the mic and read one option.</div>

              <div class="nextRow">
                <button class="ghostBtn" id="retryBtn">Retry</button>
                <button class="nextBtn" id="nextBtn">Next Table ‚ûú</button>
              </div>
            </div>
          </div>

          <aside class="board">
            <div class="boardTop">
              <div>
                <b>üèÜ Leaderboard</b>
                <div class="mini">Real time - sorted by total score</div>
              </div>
              <div class="k" id="boardCount">0 players</div>
            </div>
            <div class="boardList" id="boardList"></div>
          </aside>
        </div>
      </div>
    </section>
  </div>

  <!-- Name modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal">
      <h3>Enter player name</h3>
      <p>
        This game scores by accuracy. Saying closer to the target line gives more points.
        Scores are saved on this device.
      </p>
      <div class="row2">
        <input id="nameInput" type="text" placeholder="Your name (e.g., Minh, Lan, Alex)"/>
        <button class="startBtn" id="startBtn">Start</button>
      </div>
      <div class="smallBtns">
        <button class="ghostBtn2" id="continueBtn">Continue last player</button>
        <button class="dangerBtn" id="clearAllBtn">Clear all saved scores</button>
      </div>
    </div>
  </div>

<script>
/* ======================
   1) DATA
====================== */
const LEVELS = [
  {
    icon:"üëã",
    title:"Level 1 - Welcoming",
    tag:"üßæ Reservations",
    desc:"A guest walks in. You cannot find their name on the reservation list.",
    questionEN:"What should you say to greet and confirm politely?",
    questionVI:"B·∫°n n√™n n√≥i g√¨ ƒë·ªÉ ch√†o v√† x√°c nh·∫≠n l·ªãch s·ª±?",
    options:[
      { key:"A", text:"What do you want?", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Good evening. Do you have a reservation?", correct:true,
        accept:{
          required:[["good","evening"],["reservation"]],
          anyOf:[["do","you","have"],["have"]],
          aliases:[
            /good\s+evening.*reservation/i,
            /do\s+you\s+have\s+a\s+reservation/i
          ]
        }
      },
      { key:"C", text:"Sit anywhere you like.", correct:false, rude:false, msg:"Too casual for fine dining." }
    ]
  },
  {
    icon:"ü™ë",
    title:"Level 2 - Seating and Menu",
    tag:"ü™ë Seating",
    desc:"You have just seated the guests at their table.",
    questionEN:"What should you say when handing the menu?",
    questionVI:"B·∫°n n√™n n√≥i g√¨ khi ƒë∆∞a menu?",
    options:[
      { key:"A", text:"Here is the menu.", correct:true,
        accept:{
          required:[["menu"]],
          anyOf:[["here","is"],["heres"],["this","is"]],
          aliases:[
            /here\s+(is|s)\s+the\s+menu/i,
            /this\s+is\s+the\s+menu/i
          ]
        }
      },
      { key:"B", text:"Read this.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"C", text:"Menu.", correct:false, rude:false, msg:"Too short and abrupt." }
    ]
  },
  {
    icon:"üìù",
    title:"Level 3 - Taking Order",
    tag:"üìù Orders",
    desc:"The guest has looked at the menu for 5 minutes and closes it.",
    questionEN:"What should you say to take the order professionally?",
    questionVI:"B·∫°n n√™n n√≥i g√¨ ƒë·ªÉ nh·∫≠n order chuy√™n nghi·ªáp?",
    options:[
      { key:"A", text:"Eat what?", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Are you ready to order?", correct:true,
        accept:{
          required:[["ready"],["order"]],
          anyOf:[["are","you"],["you"]],
          aliases:[
            /are\s+you\s+ready\s+to\s+order/i,
            /ready\s+to\s+order/i
          ]
        }
      },
      { key:"C", text:"Tell me your food now.", correct:false, rude:true, msg:"Not polite enough!" }
    ]
  },
  {
    icon:"üç≥",
    title:"Level 4 - Sending to Kitchen",
    tag:"üç≥ Kitchen",
    desc:"You enter the order into POS or speak to the kitchen for Table 5.",
    questionEN:"Which line is clear and professional for the kitchen?",
    questionVI:"C√¢u n√†o r√µ r√†ng v√† chuy√™n nghi·ªáp khi b√°o b·∫øp?",
    options:[
      { key:"A", text:"Cook two steaks now!", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Table 5, two beefsteaks, medium rare, please.", correct:true,
        accept:{
          required:[
            ["table"],
            ["beef","steak"],
            ["medium","rare"],
            ["please"]
          ],
          anyOf:[["two"],["2"],["to"]],
          aliases:[
            /table\s*5.*(two|2).*beef\s*steak.*medium\s*rare.*please/i,
            /table\s*52.*beef\s*steak.*medium\s*rare.*please/i,
            /table\s*5.*beef\s*steak.*medium\s*rare.*please/i
          ]
        }
      },
      { key:"C", text:"Give me meat for table 5.", correct:false, rude:false, msg:"Unprofessional wording." }
    ]
  },
  {
    icon:"üçΩÔ∏è",
    title:"Level 5 - Serving Food",
    tag:"üçΩÔ∏è Serving",
    desc:"You bring the steak to the table.",
    questionEN:"What should you say when serving the dish?",
    questionVI:"B·∫°n n√™n n√≥i g√¨ khi mang m√≥n ra?",
    options:[
      { key:"A", text:"Your food.", correct:false, rude:false, msg:"Too curt." },
      { key:"B", text:"Here is your steak. Enjoy your meal.", correct:true,
        accept:{
          required:[["steak"],["enjoy"],["meal"]],
          anyOf:[["here","is"],["heres"]],
          aliases:[
            /here\s+(is|s)\s+your\s+steak.*enjoy\s+your\s+meal/i,
            /enjoy\s+your\s+meal/i
          ]
        }
      },
      { key:"C", text:"Eat quickly before it gets cold.", correct:false, rude:true, msg:"Not polite enough!" }
    ]
  },
  {
    icon:"üí≥",
    title:"Level 6 - Billing",
    tag:"üí≥ Payment",
    desc:"The guest asks for the bill.",
    questionEN:"What is the most professional line for payment?",
    questionVI:"C√¢u n√†o chuy√™n nghi·ªáp nh·∫•t khi thanh to√°n?",
    options:[
      { key:"A", text:"Give me money.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Pay cash or card?", correct:false, rude:false, msg:"Too direct. Needs softening." },
      { key:"C", text:"Certainly. Would you like to pay by cash or credit card?", correct:true,
        accept:{
          required:[["pay"],["cash"],["card"]],
          anyOf:[["would","you","like"],["how","would","you"]],
          aliases:[
            /would\s+you\s+like\s+to\s+pay.*cash.*(credit\s+)?card/i,
            /pay\s+by\s+cash\s+or\s+(credit\s+)?card/i
          ]
        }
      }
    ]
  },
  {
    icon:"üëã",
    title:"Level 7 - Farewell",
    tag:"üëã Goodbye",
    desc:"The guest stands up and leaves.",
    questionEN:"What should you say to close politely?",
    questionVI:"B·∫°n n√™n n√≥i g√¨ ƒë·ªÉ ch√†o t·∫°m bi·ªát l·ªãch s·ª±?",
    options:[
      { key:"A", text:"Thank you for dining with us. Have a wonderful evening.", correct:true,
        accept:{
          required:[["thank"],["dining"],["wonderful","evening"]],
          anyOf:[["with","us"],["have"],["evening"]],
          aliases:[
            /thank\s+you.*dining.*wonderful\s+evening/i,
            /have\s+a\s+wonderful\s+evening/i
          ]
        }
      },
      { key:"B", text:"Go home.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"C", text:"Bye bye.", correct:false, rude:false, msg:"Too casual for this setting." }
    ]
  }
];

let current = 0;
let locked = false;

/* ======================
   2) Storage for leaderboard
   Structure:
   scores = {
     players: {
       "Lan": { best:[...], attempts:0, total:0, avg:0 },
       ...
     },
     lastPlayer: "Lan"
   }
====================== */
const STORE_KEY = "rs_speaking_leaderboard_v1";

function loadStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return { players:{}, lastPlayer:"" };
    const obj = JSON.parse(raw);
    if(!obj.players) obj.players = {};
    if(typeof obj.lastPlayer !== "string") obj.lastPlayer = "";
    return obj;
  }catch(e){
    return { players:{}, lastPlayer:"" };
  }
}
function saveStore(store){
  localStorage.setItem(STORE_KEY, JSON.stringify(store));
}

let store = loadStore();
let player = store.lastPlayer || "";

/* ======================
   3) DOM
====================== */
const $ = (id) => document.getElementById(id);
const ui = {
  techPill: $("techPill"),
  changePlayerBtn: $("changePlayerBtn"),
  resetBoardBtn: $("resetBoardBtn"),

  fill: $("fill"),
  lvlTxt: $("lvlTxt"),

  playerName: $("playerName"),
  playerHint: $("playerHint"),
  myTotal: $("myTotal"),
  myAvg: $("myAvg"),
  myAtt: $("myAtt"),

  lvlIcon: $("lvlIcon"),
  lvlTitle: $("lvlTitle"),
  lvlDesc: $("lvlDesc"),
  lvlTag: $("lvlTag"),
  qText: $("qText"),
  qTextVI: $("qTextVI"),
  options: $("options"),

  micBtn: $("micBtn"),
  typeInput: $("typeInput"),
  checkBtn: $("checkBtn"),
  transcript: $("transcript"),
  confTxt: $("confTxt"),
  status: $("status"),
  retryBtn: $("retryBtn"),
  nextBtn: $("nextBtn"),

  boardList: $("boardList"),
  boardCount: $("boardCount"),

  modalWrap: $("modalWrap"),
  nameInput: $("nameInput"),
  startBtn: $("startBtn"),
  continueBtn: $("continueBtn"),
  clearAllBtn: $("clearAllBtn")
};

/* ======================
   4) Speech Recognition
====================== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let isListening = false;
let lastConfidence = null;
let listenTimeout = null;

function setTechPill(text, ok=true){
  ui.techPill.textContent = text;
  ui.techPill.style.borderColor = ok ? "rgba(46,229,157,.35)" : "rgba(255,93,108,.35)";
}
function speechSupported(){ return !!SpeechRecognition; }

function buildRecognition(){
  const rec = new SpeechRecognition();
  rec.lang = "en-US";
  rec.interimResults = false;
  rec.maxAlternatives = 3;
  rec.continuous = false;
  return rec;
}

function startSpeech(){
  if(!speechSupported() || locked || isListening) return;

  isListening = true;
  ui.micBtn.disabled = true;
  ui.micBtn.classList.add("listening");
  ui.micBtn.textContent = "üü¢ Listening‚Ä¶";
  ui.status.className = "status";
  ui.status.textContent = "Listening. Read ONE option clearly.";
  ui.transcript.textContent = "Listening‚Ä¶";
  ui.confTxt.textContent = "conf: -";
  lastConfidence = null;

  const rec = buildRecognition();

  clearTimeout(listenTimeout);
  listenTimeout = setTimeout(() => {
    try{ rec.stop(); } catch(e){}
  }, 7000);

  rec.onresult = (event) => {
    clearTimeout(listenTimeout);

    const res = event.results?.[0];
    const alt0 = res?.[0];
    const spoken = (alt0?.transcript || "").trim();
    const conf = (typeof alt0?.confidence === "number") ? alt0.confidence : null;
    lastConfidence = conf;

    ui.typeInput.value = spoken;
    ui.transcript.textContent = spoken || "No text captured.";
    ui.confTxt.textContent = "conf: " + (conf === null ? "-" : conf.toFixed(2));

    try{ rec.stop(); } catch(e){}

    if(spoken) checkAnswer(spoken, conf);
    else {
      ui.status.className = "status bad";
      ui.status.textContent = "No speech detected. Try again or type.";
    }
  };

  rec.onerror = (e) => {
    clearTimeout(listenTimeout);
    const err = e.error || "unknown";
    ui.status.className = "status bad";
    if(err === "no-speech"){
      ui.status.textContent = "No sound detected. Tap again and speak closer, or type the option.";
    } else if(err === "not-allowed" || err === "service-not-allowed"){
      ui.status.textContent = "Mic permission blocked. Allow Microphone and use HTTPS, or type the option.";
    } else if(err === "audio-capture"){
      ui.status.textContent = "Microphone not found. Check input device, or type the option.";
    } else {
      ui.status.textContent = "Speech error: " + err + ". Type the option if needed.";
    }
  };

  rec.onend = () => {
    clearTimeout(listenTimeout);
    isListening = false;
    ui.micBtn.classList.remove("listening");
    ui.micBtn.textContent = "üéôÔ∏è Tap to Talk";
    ui.micBtn.disabled = false;
  };

  try{ rec.start(); }
  catch(e){
    isListening = false;
    ui.micBtn.classList.remove("listening");
    ui.micBtn.textContent = "üéôÔ∏è Tap to Talk";
    ui.micBtn.disabled = false;
  }
}

/* ======================
   5) Normalization and scoring
====================== */
const NUM_WORDS = new Map([
  ["zero","0"],["one","1"],["two","2"],["to","2"],["too","2"],["three","3"],["four","4"],["for","4"],["five","5"],
  ["six","6"],["seven","7"],["eight","8"],["nine","9"],["ten","10"]
]);

function normalize(s){
  return (s || "")
    .toLowerCase()
    .replace(/‚Äô/g,"'")
    .replace(/-/g," ")
    .replace(/[^a-z0-9\s']/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function normalizeTokens(s){
  const raw = normalize(s).split(" ").filter(Boolean);
  const out = [];
  for(const t of raw){
    if(NUM_WORDS.has(t)) out.push(NUM_WORDS.get(t));
    else out.push(t);
  }
  for(let i=0;i<out.length-1;i++){
    if(out[i]==="beef" && out[i+1]==="steak"){
      out.splice(i,2,"beefsteak");
      break;
    }
  }
  return out;
}

function levenshtein(a,b){
  const an = normalize(a), bn = normalize(b);
  const m = an.length, n = bn.length;
  if(m === 0) return n;
  if(n === 0) return m;
  const dp = Array.from({length:m+1}, ()=> new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = an[i-1] === bn[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}

function similarityText(a,b){
  const an = normalize(a), bn = normalize(b);
  const maxLen = Math.max(an.length, bn.length) || 1;
  const lev = levenshtein(an, bn);
  return Math.max(0, Math.min(1, 1 - (lev / maxLen)));
}

function tokenSet(tokens){ return new Set(tokens); }

function keywordCoverage(inputTokens, accept){
  if(!accept || !accept.required) return 0;
  const set = tokenSet(inputTokens);

  let hit = 0;
  for(const group of accept.required){
    const ok = group.every(t => set.has(t));
    if(ok) hit++;
  }
  const base = hit / accept.required.length;

  let boost = 0;
  if(accept.anyOf && accept.anyOf.length){
    for(const g of accept.anyOf){
      const ok = g.every(t => set.has(t));
      if(ok){ boost = 0.10; break; }
    }
  }
  return Math.max(0, Math.min(1, base + boost));
}

function acceptAliasMatch(inputRaw, accept){
  if(!accept || !accept.aliases) return false;
  return accept.aliases.some(rx => rx.test(inputRaw));
}

function bestMatch(inputRaw, options){
  const inputTokens = normalizeTokens(inputRaw);
  const inputNorm = inputTokens.join(" ");

  let best = { opt:null, score:0, sim:0, cov:0, alias:false };

  for(const opt of options){
    const optTokens = normalizeTokens(opt.text);
    const optNorm = optTokens.join(" ");

    const sim = similarityText(inputNorm, optNorm);
    const cov = keywordCoverage(inputTokens, opt.accept);
    const alias = acceptAliasMatch(inputRaw, opt.accept);

    const hasAccept = !!opt.accept;
    const blended = hasAccept ? (0.45*sim + 0.55*cov) : sim;

    const score = alias ? Math.max(0.90, blended) : blended;

    if(score > best.score){
      best = { opt, score, sim, cov, alias };
    }
  }
  return best;
}

/* ======================
   6) Leaderboard engine
====================== */
function ensurePlayer(name){
  if(!store.players[name]){
    store.players[name] = {
      best: new Array(LEVELS.length).fill(0),
      attempts: 0
    };
  }
}

function computeStats(p){
  const best = p.best || [];
  const total = best.reduce((a,b)=>a + Math.round(b*100), 0);
  const avg = best.length ? (best.reduce((a,b)=>a+b,0) / best.length) : 0;
  return { total, avg };
}

function updatePlayerUI(){
  if(!player){
    ui.playerName.textContent = "Player: -";
    ui.playerHint.textContent = "Enter your name to start. Your score is saved on this device.";
    ui.myTotal.textContent = "0";
    ui.myAvg.textContent = "0.00";
    ui.myAtt.textContent = "0";
    return;
  }
  ensurePlayer(player);
  const p = store.players[player];
  const { total, avg } = computeStats(p);

  ui.playerName.textContent = "Player: " + player;
  ui.playerHint.textContent = "Score uses accuracy. Try to speak closer to the target line.";
  ui.myTotal.textContent = String(total);
  ui.myAvg.textContent = avg.toFixed(2);
  ui.myAtt.textContent = String(p.attempts || 0);
}

function renderLeaderboard(){
  const entries = Object.entries(store.players).map(([name, p])=>{
    const { total, avg } = computeStats(p);
    return { name, total, avg, attempts: p.attempts || 0 };
  });

  entries.sort((a,b)=>{
    if(b.total !== a.total) return b.total - a.total;
    if(b.avg !== a.avg) return b.avg - a.avg;
    return a.attempts - b.attempts;
  });

  ui.boardCount.textContent = entries.length + " players";

  ui.boardList.innerHTML = "";
  if(entries.length === 0){
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div class="rank">-</div>
      <div class="rowMain"><b>No players yet</b><span>Enter a name to start scoring</span></div>
      <div class="rowScore"><b>0</b><span>avg 0.00</span></div>
    `;
    ui.boardList.appendChild(div);
    return;
  }

  entries.slice(0, 10).forEach((e, idx)=>{
    const div = document.createElement("div");
    div.className = "row" + (e.name === player ? " you" : "");
    const medal = idx===0 ? "ü•á" : idx===1 ? "ü•à" : idx===2 ? "ü•â" : (idx+1);
    div.innerHTML = `
      <div class="rank">${medal}</div>
      <div class="rowMain">
        <b>${escapeHtml(e.name)}</b>
        <span>avg ${e.avg.toFixed(2)} - attempts ${e.attempts}</span>
      </div>
      <div class="rowScore">
        <b>${e.total}</b>
        <span>points</span>
      </div>
    `;
    ui.boardList.appendChild(div);
  });
}

function awardScore(levelIndex, accuracyScore){
  if(!player) return;

  ensurePlayer(player);
  const p = store.players[player];

  p.attempts = (p.attempts || 0) + 1;

  // Keep best score for that level
  const prev = p.best[levelIndex] || 0;
  if(accuracyScore > prev){
    p.best[levelIndex] = accuracyScore;
  }

  store.lastPlayer = player;
  saveStore(store);

  updatePlayerUI();
  renderLeaderboard();
}

/* ======================
   7) UI render
====================== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderLevel(){
  locked = false;
  ui.nextBtn.classList.remove("show");
  ui.nextBtn.style.display = "none";
  ui.status.className = "status";
  ui.status.textContent = "Ready. Tap the mic and read one option.";
  ui.transcript.textContent = "Waiting‚Ä¶";
  ui.confTxt.textContent = "conf: -";
  ui.typeInput.value = "";
  ui.checkBtn.disabled = false;
  ui.typeInput.disabled = false;
  ui.micBtn.disabled = !speechSupported();

  const L = LEVELS[current];
  ui.lvlIcon.textContent = L.icon || "üçΩÔ∏è";
  ui.lvlTitle.textContent = L.title;
  ui.lvlDesc.textContent = L.desc;
  ui.lvlTag.textContent = L.tag || "üçΩÔ∏è Service";
  ui.qText.textContent = L.questionEN || "Choose the most professional line to say.";
  ui.qTextVI.textContent = L.questionVI || "";

  ui.lvlTxt.textContent = `Level ${current+1} of ${LEVELS.length}`;
  ui.fill.style.width = `${(current / LEVELS.length) * 100}%`;

  const shuffled = [...L.options].sort(() => Math.random() - 0.5);
  ui.options.innerHTML = "";
  for(const o of shuffled){
    const div = document.createElement("div");
    div.className = "opt";
    div.innerHTML = `
      <div class="badge">${o.key || ""}</div>
      <div class="txt">${escapeHtml(o.text)}</div>
    `;
    ui.options.appendChild(div);
  }
}

/* ======================
   8) Game logic
   Scoring by accuracy:
   - When correct and passes threshold, award accuracyScore (0-1)
   - Show accuracyScore in status
====================== */
function checkAnswer(inputRaw, conf=null){
  if(locked) return;
  if(!player){
    openNameModal(true);
    ui.status.className = "status bad";
    ui.status.textContent = "Enter player name first.";
    return;
  }

  const L = LEVELS[current];
  const { opt, score } = bestMatch(inputRaw, L.options);

  const passMain = 0.80;
  const passLow = 0.76;

  if(!opt || score < 0.60){
    store.players[player] && (store.players[player].attempts = (store.players[player].attempts || 0) + 1);
    saveStore(store);
    updatePlayerUI();
    renderLeaderboard();

    ui.status.className = "status bad";
    ui.status.textContent = "Not matched. Read one option more clearly, or type it.";
    return;
  }

  if(opt.correct){
    const pass = score >= passMain || score >= passLow;
    if(pass){
      locked = true;

      // Award points
      awardScore(current, score);

      const pts = Math.round(score * 100);
      ui.status.className = "status ok";
      ui.status.textContent = `Correct. Accuracy ${score.toFixed(2)} - +${pts} points. Click Next to continue.`;

      ui.nextBtn.style.display = "inline-flex";
      ui.nextBtn.classList.add("show");
      ui.checkBtn.disabled = true;
      ui.typeInput.disabled = true;
      ui.micBtn.disabled = true;

      ui.fill.style.width = `${((current+1) / LEVELS.length) * 100}%`;
      return;
    } else {
      store.players[player].attempts = (store.players[player].attempts || 0) + 1;
      saveStore(store);
      updatePlayerUI();
      renderLeaderboard();

      ui.status.className = "status bad";
      ui.status.textContent = `Close but not clear enough (accuracy ${score.toFixed(2)}). Try again.`;
      return;
    }
  }

  // wrong option
  store.players[player].attempts = (store.players[player].attempts || 0) + 1;
  saveStore(store);
  updatePlayerUI();
  renderLeaderboard();

  ui.status.className = "status bad";
  if(opt.rude){
    ui.status.textContent = "Not polite enough!";
  } else {
    ui.status.textContent = opt.msg || "Not the best choice. Try again.";
  }
}

function next(){
  if(current >= LEVELS.length - 1){
    ui.status.className = "status ok";
    ui.status.textContent = "Completed. Change player to continue the class game.";
    ui.fill.style.width = "100%";
    ui.lvlTxt.textContent = "Completed";
    ui.micBtn.disabled = true;
    ui.typeInput.disabled = true;
    ui.checkBtn.disabled = true;
    ui.nextBtn.style.display = "none";
    return;
  }
  current++;
  renderLevel();
}

/* ======================
   9) Modal and controls
====================== */
function openNameModal(allowContinue){
  ui.modalWrap.style.display = "flex";
  ui.nameInput.value = "";
  ui.continueBtn.style.display = allowContinue ? "inline-flex" : "none";
  ui.nameInput.focus();
}

function closeNameModal(){
  ui.modalWrap.style.display = "none";
}

function setPlayer(name){
  const n = (name || "").trim();
  if(!n) return;

  player = n;
  ensurePlayer(player);
  store.lastPlayer = player;
  saveStore(store);

  updatePlayerUI();
  renderLeaderboard();
  closeNameModal();
}

ui.startBtn.addEventListener("click", ()=> setPlayer(ui.nameInput.value));
ui.nameInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") setPlayer(ui.nameInput.value); });

ui.continueBtn.addEventListener("click", ()=>{
  if(store.lastPlayer){
    setPlayer(store.lastPlayer);
  }
});

ui.clearAllBtn.addEventListener("click", ()=>{
  localStorage.removeItem(STORE_KEY);
  store = { players:{}, lastPlayer:"" };
  player = "";
  updatePlayerUI();
  renderLeaderboard();
  closeNameModal();
});

ui.changePlayerBtn.addEventListener("click", ()=> openNameModal(true));

ui.resetBoardBtn.addEventListener("click", ()=>{
  // Keep current player, clear others or clear all? Here clear all.
  localStorage.removeItem(STORE_KEY);
  store = { players:{}, lastPlayer: player || "" };
  if(player){
    ensurePlayer(player);
  }
  saveStore(store);
  updatePlayerUI();
  renderLeaderboard();
});

/* ======================
   10) Game buttons
====================== */
ui.micBtn.addEventListener("click", startSpeech);
ui.checkBtn.addEventListener("click", ()=> checkAnswer(ui.typeInput.value, null));
ui.typeInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") checkAnswer(ui.typeInput.value, null); });

ui.retryBtn.addEventListener("click", ()=>{
  if(locked) return;
  ui.status.className = "status";
  ui.status.textContent = "Retry. Tap the mic and read one option.";
  ui.typeInput.value = "";
  ui.transcript.textContent = "Waiting‚Ä¶";
  ui.confTxt.textContent = "conf: -";
});

ui.nextBtn.addEventListener("click", next);

/* ======================
   11) Init
====================== */
if(!speechSupported()){
  setTechPill("üéôÔ∏è Speech: not supported", false);
} else {
  setTechPill("üéôÔ∏è Speech: ready", true);
}

updatePlayerUI();
renderLeaderboard();
renderLevel();

if(!player){
  openNameModal(true);
}
</script>
</body>
</html>
