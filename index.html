<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Restaurant Service Speaking Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070b18;
      --card:#0f1733;
      --text:#e9ecf5;
      --muted:#b8c0da;
      --accent:#ffb020;
      --accent2:#64d2ff;
      --ok:#2ee59d;
      --bad:#ff5d6c;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1100px 600px at 18% 0%, rgba(100,210,255,.24), transparent 58%),
        radial-gradient(900px 650px at 92% 18%, rgba(255,176,32,.20), transparent 60%),
        radial-gradient(700px 500px at 55% 92%, rgba(46,229,157,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(980px, 100%);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .header{
      padding:18px 18px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.09), transparent);
      border-bottom:1px solid var(--line);
    }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,176,32,.95), rgba(100,210,255,.55));
      display:grid;place-items:center;
      font-weight:900;
      color:#070b18;
      letter-spacing:.5px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      flex:0 0 auto;
    }

    .brand h1{
      margin:0;
      font-size:18px;
      line-height:1.15;
    }
    .brand p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      color:rgba(233,236,245,.92);
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .pill b{color:#fff}
    .pill .dot{
      width:9px;height:9px;border-radius:99px;
      background: rgba(184,192,218,.65);
      box-shadow: 0 0 0 4px rgba(184,192,218,.12);
    }

    .progressWrap{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .bar{
      flex:1;
      height:9px;
      background: rgba(255,255,255,.08);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--ok), var(--accent));
      transition: width .35s ease;
    }
    .lvlTxt{
      font-size:12px;color:var(--muted);
      min-width:140px;text-align:right;
    }

    .content{ padding:18px; }

    .nameCard{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      margin-bottom:12px;
    }
    .nameLeft{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .avatar{
      width:38px;height:38px;border-radius:14px;
      background: rgba(100,210,255,.16);
      border:1px solid rgba(100,210,255,.26);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .nameMeta{
      min-width:0;
    }
    .nameMeta .n{
      font-weight:800;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .nameMeta .s{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    .scenario{
      background: linear-gradient(180deg, rgba(255,176,32,.14), rgba(255,176,32,.05));
      border:1px solid rgba(255,176,32,.22);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .scenarioTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .scenario h2{
      margin:0;
      font-size:16px;
      line-height:1.2;
    }
    .scenario .desc{
      margin:8px 0 0;
      color: rgba(233,236,245,.92);
      font-size:13px;
      line-height:1.4;
    }
    .tag{
      font-size:12px;
      color: rgba(233,236,245,.90);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      white-space:nowrap;
      user-select:none;
    }

    .qBlock{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-bottom:14px;
    }
    .qTitle{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .qTitle .icon{
      width:34px;height:34px;border-radius:12px;
      background: rgba(100,210,255,.16);
      border:1px solid rgba(100,210,255,.22);
      display:grid;place-items:center;
      font-size:18px;
    }
    .qTitle .text b{ display:block; font-size:14px; }
    .qTitle .text span{ display:block; margin-top:2px; font-size:12px; color:var(--muted); }

    .options{
      display:grid;
      gap:10px;
    }
    .opt{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .opt .badge{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      display:grid;place-items:center;
      font-weight:900;
      color: rgba(233,236,245,.95);
      flex:0 0 auto;
    }
    .opt .txt{
      font-size:13px;
      color: rgba(233,236,245,.96);
      line-height:1.35;
      flex:1;
    }

    .controls{
      display:grid;
      gap:12px;
      padding:14px;
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }

    .micRow{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }

    .micBtn{
      flex: 1 1 260px;
      border:none;
      border-radius:16px;
      padding:14px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(255,176,32,.95), rgba(255,176,32,.62));
      color:#070b18;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 36px rgba(255,176,32,.18);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .micBtn.listening{
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.62));
      box-shadow: 0 14px 36px rgba(46,229,157,.18);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse{
      0% { transform: translateY(0); }
      50% { transform: translateY(-1px); }
      100% { transform: translateY(0); }
    }
    .micBtn:disabled{opacity:.6; cursor:not-allowed;}

    .hintMini{
      flex: 1 1 300px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .k{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(233,236,245,.88);
      font-size:11px;
      user-select:none;
    }

    .typeRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .typeRow input{
      flex:1;
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px;
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    .typeRow button{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(100,210,255,.95), rgba(100,210,255,.62));
      color:#070b18;
      font-weight:900;
      cursor:pointer;
      min-width:120px;
    }
    .typeRow button:disabled{opacity:.6; cursor:not-allowed;}

    .live{
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:12px;
    }
    .live .label{
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .live .transcript{
      font-size:14px;
      line-height:1.35;
      min-height:44px;
      color: rgba(233,236,245,.95);
      white-space:pre-wrap;
    }

    .status{
      border-radius:16px;
      padding:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:13px;
      line-height:1.35;
    }
    .status.ok{
      border-color: rgba(46,229,157,.40);
      background: rgba(46,229,157,.12);
      color: rgba(233,236,245,.98);
    }
    .status.bad{
      border-color: rgba(255,93,108,.40);
      background: rgba(255,93,108,.12);
      color: rgba(233,236,245,.98);
    }

    .nextRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .nextBtn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,176,32,.95), rgba(255,176,32,.62));
      color:#070b18;
      font-weight:900;
      cursor:pointer;
      min-width:170px;
      display:none;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .nextBtn.show{display:inline-flex;}
    .ghostBtn{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      cursor:pointer;
      min-width:170px;
    }

    .endWrap{
      display:none;
      padding:18px;
    }
    .endWrap.show{display:block;}
    .endCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:18px;
      padding:16px;
      margin-bottom:14px;
    }
    .endCard h2{
      margin:0 0 6px 0;
      font-size:16px;
      color: rgba(233,236,245,.98);
    }
    .endCard p{
      margin:0;
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.62));
      color:#070b18;
    }
    .btnGhost{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: rgba(233,236,245,.92);
      text-decoration:none;
    }

    .certArea{
      display:none;
      margin-top:14px;
    }
    .certArea.show{display:block;}
    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:#fff;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.16);
      background: #0b1229;
      box-shadow: 0 22px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHead{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.08), transparent);
    }
    .modalHead h2{
      margin:0;
      font-size:16px;
    }
    .modalHead p{
      margin:6px 0 0;
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .modalBody{
      padding:16px;
      display:grid;
      gap:12px;
    }
    .modalBody input{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:12px;
      font-size:14px;
      outline:none;
    }
    .modalBody button{
      border:none;
      border-radius:14px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(46,229,157,.95), rgba(46,229,157,.62));
      color:#070b18;
    }
  </style>
</head>

<body>
  <!-- Name modal (used at start OR end if name missing) -->
  <div class="modalOverlay" id="nameOverlay" style="display:none;">
    <div class="modal">
      <div class="modalHead">
        <h2 id="nameModalTitle">Enter your name</h2>
        <p id="nameModalDesc">Your name will appear on the certificate.</p>
      </div>
      <div class="modalBody">
        <input id="nameInput" type="text" placeholder="Full name (e.g., Nguyen Van A)" maxlength="50">
        <button id="nameOkBtn">Continue</button>
      </div>
    </div>
  </div>

  <div class="app">
    <section class="panel">
      <div class="header">
        <div class="titleRow">
          <div class="brand">
            <div class="logo">RS</div>
            <div>
              <h1>Restaurant Service Speaking Game</h1>
              <p>English for Tourism - speak one of the 3 options to pass</p>
            </div>
          </div>

          <div class="pill" id="scorePill">
            <span class="dot" id="dot"></span>
            <span><b id="scoreTxt">Score: 0</b> | Attempts: <span id="attemptTxt">0</span></span>
          </div>
        </div>

        <div class="progressWrap">
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="lvlTxt" id="lvlTxt">Level 1 of 7</div>
        </div>
      </div>

      <div class="content">
        <div class="nameCard">
          <div class="nameLeft">
            <div class="avatar">üë§</div>
            <div class="nameMeta">
              <div class="n" id="playerLabel">Player</div>
              <div class="s">Tap mic once, speak, it auto checks. Next button appears after correct.</div>
            </div>
          </div>
          <div class="pill" id="micPill"><span class="dot"></span><span id="micTxt">Mic: checking</span></div>
        </div>

        <div class="scenario">
          <div class="scenarioTop">
            <div>
              <h2 id="lvlTitle">Loading‚Ä¶</h2>
              <div class="desc" id="lvlDesc">‚Ä¶</div>
            </div>
            <div class="tag" id="lvlTag">üçΩÔ∏è Service</div>
          </div>
        </div>

        <div class="qBlock">
          <div class="qTitle">
            <div class="icon">‚ùì</div>
            <div class="text">
              <b id="qText">Choose the most professional line to say.</b>
              <span id="qVi">D·ªãch: ‚Ä¶</span>
            </div>
          </div>
          <div class="options" id="options"></div>
        </div>

        <div class="controls">
          <div class="micRow">
            <button class="micBtn" id="micBtn" title="Tap to speak">üéôÔ∏è Tap to Speak</button>
            <div class="hintMini">
              <div class="k">Tip</div>
              Tap mic, speak, it auto stops and checks.<br/>
              If mic fails: use typing below.
            </div>
          </div>

          <div class="typeRow">
            <input id="typeInput" type="text" placeholder="Type one option if mic fails‚Ä¶" />
            <button id="checkBtn">Check</button>
          </div>

          <div class="live">
            <div class="label">
              <span>Live transcript</span>
              <span id="confTxt" class="k">conf: -</span>
            </div>
            <div class="transcript" id="transcript">Waiting‚Ä¶</div>
          </div>

          <div class="status" id="status">Ready. Tap the mic button and read one option.</div>

          <div class="nextRow">
            <button class="ghostBtn" id="retryBtn">Retry</button>
            <button class="nextBtn" id="nextBtn">Next Table ‚ûú</button>
          </div>
        </div>

        <!-- End screen -->
        <div class="endWrap" id="endWrap">
          <div class="endCard">
            <h2>Completed</h2>
            <p>Generate and download your certificate PNG.</p>

            <div class="btnRow">
              <button class="btn btnPrimary" id="makeCertBtn">Generate certificate</button>
              <a class="btn btnGhost" id="downloadCertBtn" style="display:none;" download="Certificate.png">Download PNG</a>
              <button class="btn btnGhost" id="replayBtn">Replay</button>
            </div>
          </div>

          <div class="certArea" id="certArea">
            <canvas id="certCanvas" width="1400" height="900"></canvas>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ======================
   GAME DATA
====================== */
const LEVELS = [
  {
    title: "Level 1 - Welcoming",
    tag: "üßæ Reservations",
    desc: "A guest walks in. You cannot find their name on the reservation list.",
    question: "What should you say to greet and confirm politely?",
    vi: "B·∫°n n√™n n√≥i g√¨ ƒë·ªÉ ch√†o v√† x√°c nh·∫≠n ƒë·∫∑t b√†n l·ªãch s·ª±?",
    options: [
      { key:"A", text:"What do you want?", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Good evening. Do you have a reservation?", correct:true },
      { key:"C", text:"Sit anywhere you like.", correct:false, rude:false, msg:"Too casual for fine dining." }
    ]
  },
  {
    title: "Level 2 - Seating and Menu",
    tag: "ü™ë Seating",
    desc: "You have just seated the guests at their table.",
    question: "What should you say when handing the menu?",
    vi: "Khi ƒë∆∞a menu, b·∫°n n√™n n√≥i g√¨?",
    options: [
      { key:"A", text:"Here is the menu.", correct:true },
      { key:"B", text:"Read this.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"C", text:"Menu.", correct:false, rude:false, msg:"Too short and abrupt." }
    ]
  },
  {
    title: "Level 3 - Taking Order",
    tag: "üìù Orders",
    desc: "The guest has looked at the menu for 5 minutes and closes it.",
    question: "What should you say to take the order professionally?",
    vi: "B·∫°n n√™n n√≥i g√¨ ƒë·ªÉ g·ªçi m√≥n chuy√™n nghi·ªáp?",
    options: [
      { key:"A", text:"Eat what?", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Are you ready to order?", correct:true },
      { key:"C", text:"Tell me your food now.", correct:false, rude:true, msg:"Not polite enough!" }
    ]
  },
  {
    title: "Level 4 - Sending to Kitchen",
    tag: "üç≥ Kitchen",
    desc: "You enter the order into POS or speak to the kitchen for Table 5.",
    question: "Which line is clear and professional for the kitchen?",
    vi: "C√¢u n√†o r√µ r√†ng, chu·∫©n nghi·ªáp v·ª• khi b√°o b·∫øp?",
    options: [
      { key:"A", text:"Cook two steaks now!", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Table 5, two beefsteaks, medium rare, please.", correct:true },
      { key:"C", text:"Give me meat for table 5.", correct:false, rude:false, msg:"Unprofessional wording." }
    ]
  },
  {
    title: "Level 5 - Serving Food",
    tag: "üçΩÔ∏è Serving",
    desc: "You bring the steak to the table.",
    question: "What should you say when serving the dish?",
    vi: "Khi b∆∞ng m√≥n ra, b·∫°n n√™n n√≥i g√¨?",
    options: [
      { key:"A", text:"Your food.", correct:false, rude:false, msg:"Too curt." },
      { key:"B", text:"Here is your steak. Enjoy your meal.", correct:true },
      { key:"C", text:"Eat quickly before it gets cold.", correct:false, rude:true, msg:"Not polite enough!" }
    ]
  },
  {
    title: "Level 6 - Billing",
    tag: "üí≥ Payment",
    desc: "The guest asks for the bill.",
    question: "What is the most professional line for payment?",
    vi: "Khi thanh to√°n, c√¢u n√†o l·ªãch s·ª± nh·∫•t?",
    options: [
      { key:"A", text:"Give me money.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"B", text:"Pay cash or card?", correct:false, rude:false, msg:"Too direct. Needs softening." },
      { key:"C", text:"Certainly. Would you like to pay by cash or credit card?", correct:true }
    ]
  },
  {
    title: "Level 7 - Farewell",
    tag: "üëã Goodbye",
    desc: "The guest stands up and leaves.",
    question: "What should you say to close politely?",
    vi: "Khi kh√°ch ra v·ªÅ, b·∫°n n√™n n√≥i g√¨?",
    options: [
      { key:"A", text:"Thank you for dining with us. Have a wonderful evening.", correct:true },
      { key:"B", text:"Go home.", correct:false, rude:true, msg:"Not polite enough!" },
      { key:"C", text:"Bye bye.", correct:false, rude:false, msg:"Too casual for this setting." }
    ]
  }
];

/* ======================
   STATE + DOM
====================== */
const $ = (id) => document.getElementById(id);

const ui = {
  nameOverlay: $("nameOverlay"),
  nameModalTitle: $("nameModalTitle"),
  nameModalDesc: $("nameModalDesc"),
  nameInput: $("nameInput"),
  nameOkBtn: $("nameOkBtn"),

  playerLabel: $("playerLabel"),
  micPill: $("micPill"),
  micTxt: $("micTxt"),

  fill: $("fill"),
  lvlTxt: $("lvlTxt"),
  lvlTitle: $("lvlTitle"),
  lvlDesc: $("lvlDesc"),
  lvlTag: $("lvlTag"),
  qText: $("qText"),
  qVi: $("qVi"),
  options: $("options"),

  micBtn: $("micBtn"),
  typeInput: $("typeInput"),
  checkBtn: $("checkBtn"),
  transcript: $("transcript"),
  confTxt: $("confTxt"),
  status: $("status"),
  retryBtn: $("retryBtn"),
  nextBtn: $("nextBtn"),

  scoreTxt: $("scoreTxt"),
  attemptTxt: $("attemptTxt"),
  dot: $("dot"),

  endWrap: $("endWrap"),
  makeCertBtn: $("makeCertBtn"),
  downloadCertBtn: $("downloadCertBtn"),
  replayBtn: $("replayBtn"),
  certArea: $("certArea"),
  certCanvas: $("certCanvas"),
};

let player = "";        // can be empty until end
let current = 0;
let locked = false;
let finished = false;

let totalScore = 0;     // sum of correct scores (0-100)
let attempts = 0;
let mistakes = 0;
let accuracySum = 0;
let lastConfidence = null;

/* ======================
   Speech Recognition
====================== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;
let isListening = false;

function setMicStatus(text, ok){
  ui.micTxt.textContent = text;
  ui.micPill.style.borderColor = ok ? "rgba(46,229,157,.35)" : "rgba(255,93,108,.35)";
  ui.micPill.querySelector(".dot").style.background = ok ? "rgba(46,229,157,.85)" : "rgba(255,93,108,.85)";
}

function initSpeech(){
  if(!SpeechRecognition){
    setMicStatus("Mic: not supported", false);
    ui.micBtn.disabled = true;
    ui.micBtn.textContent = "üéôÔ∏è Mic unavailable (use typing)";
    return;
  }

  rec = new SpeechRecognition();
  rec.lang = "en-US";
  rec.interimResults = true;
  rec.maxAlternatives = 3;
  rec.continuous = false;

  rec.onstart = () => {
    isListening = true;
    lastConfidence = null;
    ui.micBtn.classList.add("listening");
    ui.status.className = "status";
    ui.status.textContent = "Listening‚Ä¶ Speak now.";
    ui.transcript.textContent = "Listening‚Ä¶";
    ui.confTxt.textContent = "conf: ‚Ä¶";
  };

  rec.onend = () => {
    isListening = false;
    ui.micBtn.classList.remove("listening");
  };

  rec.onerror = (e) => {
    isListening = false;
    ui.micBtn.classList.remove("listening");
    ui.status.className = "status bad";
    const err = e.error || "unknown";
    if(err === "no-speech"){
      ui.status.textContent = "No sound detected. Tap mic and try again, or type the option.";
    } else if(err === "not-allowed" || err === "service-not-allowed"){
      ui.status.textContent = "Mic permission blocked. Allow microphone access, then try again.";
    } else if(err === "audio-capture"){
      ui.status.textContent = "Mic not found. Check device input, or type.";
    } else {
      ui.status.textContent = "Speech error: " + err + ". Use typing if needed.";
    }
  };

  rec.onresult = (event) => {
    let interim = "";
    let finalText = "";
    let bestConf = null;

    for(let i = event.resultIndex; i < event.results.length; i++){
      const res = event.results[i];
      const alt = res[0];
      if(res.isFinal){
        finalText += alt.transcript + " ";
        bestConf = alt.confidence;
      } else {
        interim += alt.transcript;
      }
    }

    if(interim){
      ui.transcript.textContent = interim.trim();
      ui.confTxt.textContent = "conf: ‚Ä¶";
    }

    if(finalText.trim()){
      const spoken = finalText.trim();
      lastConfidence = (typeof bestConf === "number") ? bestConf : null;

      ui.typeInput.value = spoken;
      ui.transcript.textContent = spoken;
      ui.confTxt.textContent = "conf: " + (lastConfidence === null ? "-" : lastConfidence.toFixed(2));

      checkAnswer(spoken); // auto check immediately
    }
  };

  setMicStatus("Mic: ready", true);
}

/* ======================
   Matching + scoring
====================== */
function normalize(s){
  return (s || "")
    .toLowerCase()
    .replace(/‚Äô/g,"'")
    .replace(/[^a-z0-9\s']/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function tokenize(s){
  return normalize(s).split(" ").filter(Boolean);
}
function tokenSet(s){
  return new Set(tokenize(s));
}
function jaccard(a, b){
  const A = tokenSet(a), B = tokenSet(b);
  if(A.size === 0 || B.size === 0) return 0;
  let inter = 0;
  for(const x of A){ if(B.has(x)) inter++; }
  const union = A.size + B.size - inter;
  return inter / union;
}
function levenshtein(a,b){
  a = normalize(a); b = normalize(b);
  const m = a.length, n = b.length;
  if(m === 0) return n;
  if(n === 0) return m;
  const dp = Array.from({length:m+1}, ()=> new Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[m][n];
}
function similarity(a,b){
  const an = normalize(a), bn = normalize(b);
  const maxLen = Math.max(an.length, bn.length) || 1;
  const levScore = 1 - (levenshtein(an, bn) / maxLen);
  const jac = jaccard(an, bn);

  // keyword coverage bonus for variants
  const A = tokenize(an), B = tokenize(bn);
  const key = new Set(B.filter(w => w.length >= 4));
  let hit = 0;
  for(const w of A){
    if(key.has(w)) hit++;
    else{
      for(const k of key){
        if(w.startsWith(k) || k.startsWith(w)){
          hit++;
          break;
        }
      }
    }
  }
  const cover = key.size ? Math.min(1, hit / key.size) : 0;

  const base = 0.58 * levScore + 0.32 * jac + 0.10 * cover;
  return Math.max(0, Math.min(1, base));
}
function bestMatch(input, options){
  let best = { opt:null, score:0 };
  for(const opt of options){
    const sc = similarity(input, opt.text);
    if(sc > best.score){
      best = { opt, score: sc };
    }
  }
  return best;
}

/* ======================
   Render + UI
====================== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function updateScoreUI(){
  ui.scoreTxt.textContent = "Score: " + Math.round(totalScore);
  ui.attemptTxt.textContent = String(attempts);
  ui.dot.style.background = finished ? "rgba(46,229,157,.85)" : "rgba(184,192,218,.65)";
}

function renderLevel(){
  if(current >= LEVELS.length){
    finishGame();
    return;
  }

  locked = false;
  finished = false;
  ui.nextBtn.classList.remove("show");
  ui.status.className = "status";
  ui.status.textContent = "Ready. Tap the mic button and read one option.";
  ui.transcript.textContent = "Waiting‚Ä¶";
  ui.confTxt.textContent = "conf: -";
  ui.typeInput.value = "";
  ui.checkBtn.disabled = false;
  ui.typeInput.disabled = false;
  ui.micBtn.disabled = !rec;

  const L = LEVELS[current];
  ui.lvlTitle.textContent = L.title;
  ui.lvlDesc.textContent = L.desc;
  ui.lvlTag.textContent = L.tag || "üçΩÔ∏è Service";
  ui.qText.textContent = L.question || "Choose the most professional line to say.";
  ui.qVi.textContent = "D·ªãch: " + (L.vi || "");

  ui.lvlTxt.textContent = `Level ${current+1} of ${LEVELS.length}`;
  ui.fill.style.width = `${(current / LEVELS.length) * 100}%`;

  const shuffled = [...L.options].sort(() => Math.random() - 0.5);
  ui.options.innerHTML = "";
  for(const o of shuffled){
    const div = document.createElement("div");
    div.className = "opt";
    div.innerHTML = `
      <div class="badge">${escapeHtml(o.key || "")}</div>
      <div class="txt">${escapeHtml(o.text)}</div>
    `;
    ui.options.appendChild(div);
  }

  updateScoreUI();
}

function finishGame(){
  finished = true;
  ui.fill.style.width = "100%";
  ui.lvlTxt.textContent = "Completed";
  ui.status.className = "status ok";
  ui.status.textContent = "Completed. Generate your certificate.";

  ui.endWrap.classList.add("show");
  updateScoreUI();

  // If player name is missing, ask now
  if(!player){
    openNameModal_("Enter your name to generate certificate", "Your name will appear on the certificate.");
  }
}

/* ======================
   Answer check
====================== */
function checkAnswer(input){
  if(locked) return;
  if(!input || !input.trim()){
    ui.status.className = "status bad";
    ui.status.textContent = "Empty input. Try again.";
    return;
  }

  const L = LEVELS[current];
  const { opt, score } = bestMatch(input, L.options);

  const conf = (lastConfidence === null ? 0 : lastConfidence);
  const passScore = (conf >= 0.70) ? 0.78 : 0.84;

  attempts++;
  accuracySum += score;

  if(!opt || score < 0.62){
    mistakes++;
    ui.status.className = "status bad";
    ui.status.textContent = "Not matched. Read closer to one option, or type it.";
    updateScoreUI();
    return;
  }

  if(!opt.correct){
    mistakes++;
    ui.status.className = "status bad";
    ui.status.textContent = opt.rude ? "Not polite enough!" : (opt.msg || "Not the best choice. Try again.");
    updateScoreUI();
    return;
  }

  // Correct choice, but require minimum closeness to pass
  if(score < passScore){
    mistakes++;
    ui.status.className = "status bad";
    ui.status.textContent = `Close, but not enough. Accuracy ${(score*100).toFixed(0)}%. Try again.`;
    updateScoreUI();
    return;
  }

  locked = true;
  const gained = Math.round(score * 100);
  totalScore += gained;

  ui.status.className = "status ok";
  ui.status.textContent = `Correct. Accuracy ${(score*100).toFixed(0)}%. (+${gained} pts)`;

  ui.nextBtn.classList.add("show");
  ui.checkBtn.disabled = true;
  ui.typeInput.disabled = true;
  ui.micBtn.disabled = true;

  ui.fill.style.width = `${((current+1) / LEVELS.length) * 100}%`;
  updateScoreUI();
}

/* ======================
   Mic button behavior: tap once, auto listen, auto stop
====================== */
function startMicOneShot_(){
  if(!rec || locked) return;

  if(isListening){
    // If somehow still listening, ignore extra taps
    return;
  }

  try{
    rec.start();
  } catch(e){
    // Some browsers throw if called too quickly after end
    ui.status.className = "status bad";
    ui.status.textContent = "Mic busy. Wait 1 second and tap again, or use typing.";
  }
}

ui.micBtn.addEventListener("click", startMicOneShot_);

/* ======================
   Other controls
====================== */
ui.checkBtn.addEventListener("click", ()=> checkAnswer(ui.typeInput.value));
ui.typeInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") checkAnswer(ui.typeInput.value); });

ui.retryBtn.addEventListener("click", ()=>{
  if(locked) return;
  ui.status.className = "status";
  ui.status.textContent = "Retry. Tap mic and read one option.";
  ui.typeInput.value = "";
  ui.transcript.textContent = "Waiting‚Ä¶";
  ui.confTxt.textContent = "conf: -";
});

ui.nextBtn.addEventListener("click", ()=>{
  current++;
  renderLevel();
});

ui.replayBtn.addEventListener("click", ()=>{
  current = 0;
  locked = false;
  finished = false;
  totalScore = 0;
  attempts = 0;
  mistakes = 0;
  accuracySum = 0;
  ui.endWrap.classList.remove("show");
  ui.certArea.classList.remove("show");
  ui.downloadCertBtn.style.display = "none";
  renderLevel();
});

/* ======================
   Name modal (used only when needed)
====================== */
function openNameModal_(title, desc){
  ui.nameModalTitle.textContent = title;
  ui.nameModalDesc.textContent = desc;
  ui.nameInput.value = player || "";
  ui.nameOverlay.style.display = "flex";
  setTimeout(()=> ui.nameInput.focus(), 50);
}

function closeNameModal_(){
  ui.nameOverlay.style.display = "none";
}

ui.nameOkBtn.addEventListener("click", ()=>{
  const nm = ui.nameInput.value.trim();
  if(!nm){
    ui.nameInput.focus();
    return;
  }
  player = nm;
  ui.playerLabel.textContent = player;
  closeNameModal_();
});

ui.nameInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") ui.nameOkBtn.click(); });

/* ======================
   Certificate
====================== */
function computeAvgAccuracy_(){
  return attempts ? (accuracySum / attempts) : 0;
}

function drawCertificate_(){
  const c = ui.certCanvas;
  const ctx = c.getContext("2d");
  const W = c.width;
  const H = c.height;

  const avgAcc = computeAvgAccuracy_();
  const scoreText = `${Math.round(totalScore)} pts`;
  const accText = `${Math.round(avgAcc * 100)}%`;

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,W,H);

  ctx.lineWidth = 18;
  ctx.strokeStyle = "#0f1733";
  ctx.strokeRect(24, 24, W-48, H-48);

  ctx.lineWidth = 4;
  ctx.strokeStyle = "#ffb020";
  ctx.strokeRect(52, 52, W-104, H-104);

  ctx.save();
  ctx.globalAlpha = 0.06;
  ctx.fillStyle = "#64d2ff";
  for(let i=0;i<16;i++){
    ctx.beginPath();
    ctx.arc(200 + i*70, 160 + (i%2)*40, 80, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();

  ctx.textAlign = "center";
  ctx.fillStyle = "#0f1733";
  ctx.font = "700 44px 'Playfair Display', serif";
  ctx.fillText("CERTIFICATE OF COMPLETION", W/2, 170);

  ctx.font = "600 22px Poppins, sans-serif";
  ctx.fillStyle = "#111827";
  ctx.fillText("English for Tourism - Restaurant Service Speaking Game", W/2, 220);

  ctx.fillStyle = "#0f1733";
  ctx.font = "900 54px Poppins, sans-serif";
  ctx.fillText((player || "STUDENT").toUpperCase(), W/2, 335);

  ctx.font = "500 24px Poppins, sans-serif";
  ctx.fillStyle = "#374151";
  ctx.fillText("has successfully completed all service scenarios.", W/2, 385);

  const boxW = 980, boxH = 170;
  const bx = (W - boxW)/2, by = 455;
  ctx.fillStyle = "#0f1733";
  ctx.globalAlpha = 0.06;
  ctx.fillRect(bx, by, boxW, boxH);
  ctx.globalAlpha = 1;

  ctx.strokeStyle = "rgba(15,23,51,.18)";
  ctx.lineWidth = 2;
  ctx.strokeRect(bx, by, boxW, boxH);

  ctx.fillStyle = "#0f1733";
  ctx.font = "800 30px Poppins, sans-serif";
  ctx.fillText("Total Score", bx + boxW*0.25, by + 70);
  ctx.fillText("Avg Accuracy", bx + boxW*0.75, by + 70);

  ctx.font = "900 46px Poppins, sans-serif";
  ctx.fillStyle = "#0f1733";
  ctx.fillText(scoreText, bx + boxW*0.25, by + 125);
  ctx.fillText(accText, bx + boxW*0.75, by + 125);

  ctx.font = "500 18px Poppins, sans-serif";
  ctx.fillStyle = "#6b7280";
  const now = new Date();
  ctx.fillText("Issued on " + now.toLocaleDateString() + " " + now.toLocaleTimeString(), W/2, H - 130);

  ctx.font = "700 20px Poppins, sans-serif";
  ctx.fillStyle = "#0f1733";
  ctx.fillText("Lesson 4 - Restaurant Service", W/2, H - 90);

  ctx.save();
  ctx.translate(W - 220, H - 210);
  ctx.rotate(-0.12);
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "#ffb020";
  ctx.beginPath();
  ctx.arc(0,0,70,0,Math.PI*2);
  ctx.fill();
  ctx.fillStyle = "#0f1733";
  ctx.font = "900 20px Poppins, sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("PASSED", 0, 8);
  ctx.restore();

  const url = c.toDataURL("image/png");
  ui.downloadCertBtn.href = url;
  ui.downloadCertBtn.style.display = "inline-flex";
}

ui.makeCertBtn.addEventListener("click", ()=>{
  if(!player){
    openNameModal_("Enter your name", "Required to generate certificate.");
    return;
  }
  ui.certArea.classList.add("show");
  drawCertificate_();
});

/* ======================
   Init
====================== */
(function init(){
  ui.playerLabel.textContent = player || "Player";
  ui.endWrap.classList.remove("show");
  initSpeech();
  renderLevel();
})();
</script>
</body>
</html>
